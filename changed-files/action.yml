name: "üêô Check: Source code changes"
description: "Checks for source code changes between commits."

inputs:
  head-ref:
    description: "The tree-like git object which will be compared against 'base-ref'."
    required: false
    default: "${{ github.ref }}"
  base-ref:
    description: "The tree-like git object which 'head-ref' will be compared against."
    required: false
    default: "${{ github.event_name == 'pull_request' && github.base_ref || format('{0}~1', github.ref) }}"
  include:
    description: "A file or directory to restrict changed files to (may be a glob expression)."
    required: false
    default: "*"
  exclude:
    description: "A file or directory to exclude from results (may be a glob expression)."
    required: false

outputs:
  changed:
    description: "Whether any files changed."
    value: ${{ steps.diff-tree.outputs.changed }}

runs:
  using: "composite"
  steps:
    - name: Evaluate changed files
      id: diff-tree
      shell: bash
      run: |-
        PY_SCRIPT_FILES=$(cat <<-EOM
          from glob import glob
          included=set(glob("${{ inputs.include }}",recursive=True,include_hidden=True))
          excluded=set(glob("${{ inputs.exclude }}",recursive=True,include_hidden=True))
          print(" ".join(sorted(included-excluded)))
        EOM
        )

        CHANGED=$(git diff-tree ${{ inputs.head-ref }} ${{ inputs.base-ref }} $(python3 -c "$PY_SCRIPT_FILES"))
        echo "changed=$([[ ! -z "$CHANGED" ]] && echo true)" >> "$GITHUB_OUTPUT"
