name: "ðŸ³ Publish: 'compile-godot-export-template' image"

on:
  workflow_call:
    inputs:
      platform:
        type: string
        description: "The platform for which to build the image for."
        required: true
      godot-major-minor-version:
        type: string
        description: "The Godot major-minor version supported by the image."
        required: true
      force:
        type: boolean
        description: "Whether to rebuild the image without using cached layers."
        required: false
        default: false
      timeout:
        type: number
        description: "The workflow's maximum allowed run duration (in minutes)."
        required: false
        default: 300

      godot-angle-static-version:
        type: string
        description: "The 'godot-angle-static' release version to install in the image."
        required: false

      # MacOS-specific inputs.
      clang-version:
        type: string
        description: "The Apple 'clang' version to install in the image."
        required: false
      moltenvk-version:
        type: string
        description: "The 'MoltenVK' SDK version to install in the image."
        required: false
      osx-version:
        type: string
        description: "The 'MacOS' SDK version to install in the image."
        required: false
      osx-version-min:
        type: string
        description: "The minimum 'MacOS' SDK version to support."
        required: false
      osxcross-sdk:
        type: string
        description: "The 'darwin*' SDK name for the 'osx-version' specified."
        required: false
      rust-version:
        type: string
        description: "The 'rust' version to install in the image."
        required: false
      xcode-version:
        type: string
        description: "The 'Xcode' version to build 'macOS'-related SDKs with."
        required: false

      # Web-specific inputs.
      emscripten-version:
        type: string
        description: "The 'Emscripten' SDK version to install in the image."
        required: false

      # Windows-specific inputs.
      mingw-llvm-version:
        type: string
        description: "The 'MinGW-LLVM' compiler version to install in the image."
        required: false
      godot-nir-static-version:
        type: string
        description: "The 'godot-nir-static' release version to install in the image."
        required: false
      pix-version:
        type: string
        description: "The PIX on Windows version to install in the image."
        required: false
      agility-version:
        type: string
        description: "The Agility SDK version to install in the image."
        required: false
  workflow_dispatch:
    inputs:
      platform:
        type: choice
        description: "The platform for which to build the image for."
        default: "windows"
        required: true
        options:
          - "macos"
          - "web"
          - "windows"
      godot-major-minor-version:
        type: string
        description: "The Godot major-minor version supported by the image."
        required: true

      force:
        type: boolean
        description: "Whether to rebuild the image without using cached layers."
        required: false
        default: false
      timeout:
        type: number
        description: "The workflow's maximum allowed run duration (in minutes)."
        required: false
        default: 300

permissions:
  contents: write
  packages: write

jobs:
  # NOTE: This job exists just to allow defining default input values *once*,
  # regardless of whether an input is set for the workflow's event type.
  inputs:
    runs-on: ubuntu-latest
    timeout-minutes: 1

    outputs:
      godot-angle-static-version: ${{ inputs.godot-angle-static-version || 'chromium/7578' }} # https://github.com/godotengine/godot-build-scripts/blob/f96241dc42946e717e69a836aae8280759b3127c/build.sh#L184

      # MacOS-specific inputs.

      clang-version: ${{ inputs.clang-version || '19.1.5' }} # https://github.com/godotengine/build-containers/blob/a8991faab8b279249f238b66f7c14c0c311ccd27/Dockerfile.osx#L26
      # IF/ELSE: Update the minimum macOS version if needed.
      moltenvk-version: ${{ inputs.moltenvk-version || '1.4.1' }} # https://github.com/godotengine/godot-build-scripts/blob/f96241dc42946e717e69a836aae8280759b3127c/build.sh#L161
      osx-version: ${{ inputs.osx-version || '26.1' }} # https://github.com/godotengine/build-containers/blob/a8991faab8b279249f238b66f7c14c0c311ccd27/Dockerfile.osx#L9
      # NOTE: MoltenVK requires at least macOS 11.0; see
      # https://github.com/KhronosGroup/MoltenVK/blob/v1.4.1/Docs/MoltenVK_Runtime_UserGuide.md#build-and-runtime-requirements.
      osx-version-min: ${{ inputs.osx-version-min || '11.0' }}
      osxcross-sdk: ${{ inputs.osxcross-sdk || 'darwin25.1' }} # https://github.com/godotengine/godot-build-scripts/blob/f96241dc42946e717e69a836aae8280759b3127c/build-macos/build.sh#L8
      rust-version: ${{ inputs.rust-version || '1.93.0' }}
      xcode-version: ${{ inputs.xcode-version || '26.1.1' }} # https://github.com/godotengine/build-containers/blob/a8991faab8b279249f238b66f7c14c0c311ccd27/Dockerfile.osx#L8C16-L8C22

      # Web-specific inputs.

      emscripten-version: ${{ inputs.emscripten-version || '4.0.20' }} # https://github.com/godotengine/build-containers/blob/a8991faab8b279249f238b66f7c14c0c311ccd27/Dockerfile.web#L4

      # Windows-specific inputs.

      mingw-llvm-version: ${{ inputs.mingw-llvm-version || '20251118' }} # https://github.com/godotengine/build-containers/blob/a8991faab8b279249f238b66f7c14c0c311ccd27/Dockerfile.windows#L6
      godot-nir-static-version: ${{ inputs.godot-nir-static-version || '25.3.1-1' }} # https://github.com/godotengine/godot/blob/543f47485c0c952b122747ef05af60e778c44139/misc/scripts/install_d3d12_sdk_windows.py#L36
      pix-version: ${{ inputs.pix-version || '1.0.240308001' }} # https://github.com/godotengine/godot/blob/543f47485c0c952b122747ef05af60e778c44139/misc/scripts/install_d3d12_sdk_windows.py#L39
      agility-version: ${{ inputs.agility-version || '1.618.5' }} # https://github.com/godotengine/godot/blob/543f47485c0c952b122747ef05af60e778c44139/misc/scripts/install_d3d12_sdk_windows.py#L46

    steps:
      - name: Placeholder step
        shell: bash
        run: exit 0

  package-macos-sdk:
    needs: ["inputs"]
    if: inputs.platform == 'macos'

    uses: ./.github/workflows/package-macos-sdk.yml
    secrets: "inherit"
    with:
      version: ${{ needs.inputs.outputs.osx-version }}
      xcode-version: ${{ needs.inputs.outputs.xcode-version }}

  package-moltenvk-sdk:
    needs: ["inputs"]
    if: inputs.platform == 'macos'

    uses: ./.github/workflows/package-moltenvk-sdk.yml
    secrets: "inherit"
    with:
      version: ${{ needs.inputs.outputs.moltenvk-version }}
      osx-version-min: ${{ needs.inputs.outputs.osx-version-min }}
      xcode-version: ${{ needs.inputs.outputs.xcode-version }}

  build-and-publish:
    if: |
      always() &&
      (
        needs.package-macos-sdk.result == 'success' ||
        (inputs.platform != 'macos' && needs.package-macos-sdk.result == 'skipped')
      ) ||
      (
        needs.package-moltenvk-sdk.result == 'success' ||
        (inputs.platform != 'macos' && needs.package-moltenvk-sdk.result == 'skipped')
      )

    needs: ["inputs", "package-macos-sdk", "package-moltenvk-sdk"]

    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(inputs.timeout) }}

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          submodules: ${{ inputs.platform == 'macos' }}

      - name: Configure runner
        if: inputs.platform == 'macos'
        uses: ./.github/actions/setup-runner

      # -------------------- Set up build contexts (MacOS) ------------------- #

      # Extract macOS SDK
      - name: Download 'macOS' SDK artifact
        if: inputs.platform == 'macos'
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          key: ${{ needs.package-macos-sdk.outputs.cache-key }}
          path: ${{ needs.package-macos-sdk.outputs.cache-path }}

      - name: Relocate 'macOS' SDK artifact
        if: inputs.platform == 'macos'
        run: >
          mv
          ${{ needs.package-macos-sdk.outputs.cache-path }}
          "thirdparty/osxcross/tarballs"

      # Extract MoltenVK SDK
      - name: Download 'MoltenVK' SDK artifact
        if: inputs.platform == 'macos'
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53
        with:
          name: ${{ needs.package-moltenvk-sdk.outputs.name }}

      - name: Copy 'MoltenVK' SDK into context
        if: inputs.platform == 'macos'
        run: tar -C thirdparty/moltenvk -xf ${{ needs.package-moltenvk-sdk.outputs.name }}

      # ------------------------------ Build the image ----------------------------- #

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      # MacOS

      - name: Build and push
        id: build-and-push-macos
        if: inputs.platform == 'macos'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: compile-godot-export-template/macos
          push: true
          tags: ghcr.io/coffeebeats/compile-godot-export-template:godot-v${{ inputs.godot-major-minor-version }}-macos
          no-cache: ${{ inputs.force }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            CLANG_VERSION=${{ needs.inputs.outputs.clang-version }}
            MACOS_VERSION=${{ needs.inputs.outputs.osx-version }}
            MACOS_VERSION_MINIMUM=${{ needs.inputs.outputs.osx-version-min }}
            OSXCROSS_SDK=${{ needs.inputs.outputs.osxcross-sdk }}
            GODOT_ANGLE_STATIC_VERSION=${{ needs.inputs.outputs.godot-angle-static-version }}
          build-contexts: |
            osxcross=thirdparty/osxcross
            patches=thirdparty/.patches
            vulkan=thirdparty/moltenvk

      # Web

      - name: Build and push
        id: build-and-push-web
        if: inputs.platform == 'web'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: compile-godot-export-template/web
          push: true
          tags: ghcr.io/coffeebeats/compile-godot-export-template:godot-v${{ inputs.godot-major-minor-version }}-web
          no-cache: ${{ inputs.force }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            EMSCRIPTEN_SDK_VERSION=${{ needs.inputs.outputs.emscripten-version }}
          build-contexts: |
            patches=thirdparty/.patches

      # Windows

      - name: Build and push
        id: build-and-push-windows
        if: inputs.platform == 'windows'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: compile-godot-export-template/windows
          push: true
          tags: ghcr.io/coffeebeats/compile-godot-export-template:godot-v${{ inputs.godot-major-minor-version }}-windows
          no-cache: ${{ inputs.force }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            MINGW_LLVM_VERSION=${{ needs.inputs.outputs.mingw-llvm-version }}
            GODOT_NIR_STATIC_VERSION=${{ needs.inputs.outputs.godot-nir-static-version }}
            PIX_VERSION=${{ needs.inputs.outputs.pix-version }}
            AGILITY_VERSION=${{ needs.inputs.outputs.agility-version }}
            GODOT_ANGLE_STATIC_VERSION=${{ needs.inputs.outputs.godot-angle-static-version }}
          build-contexts: |
            patches=thirdparty/.patches

  remove-stale-images:
    needs: ["build-and-publish"]
    if: |
      always() &&
      needs.build-and-publish.result == 'success'

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/delete-package-versions@e5bc658cc4c965c472efe991f8beea3981499c55
        with:
          owner: "coffeebeats"
          package-name: "compile-godot-export-template"
          package-type: "container"
          delete-only-untagged-versions: true
          min-versions-to-keep: 25 # NOTE: This is an arbitrary value.
