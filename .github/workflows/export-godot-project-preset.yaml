name: "ðŸ¤– Export: Godot project preset"

on:
  workflow_call:
    inputs:
      project-path:
        type: string
        description: "The path to the Godot project."
        required: true

      preset-name:
        type: string
        description: "The name of the Godot project export preset."
        required: true
      preset-output-name:
        type: string
        description: "The output filename of the exported Godot project preset."
        required: true
      pck-only:
        type: boolean
        description: "Whether to export a PCK file instead of an executable."
        required: false
        default: false

      godot-editor-version:
        type: string
        description: "The full semantic version of the Godot editor."
        required: true
      export-template-artifact-name:
        type: string
        description: "The name of the Godot export template artifact to download."
        required: true

      profile:
        type: string
        description: "The optimization profile of the compiled export template."
        required: false
        default: release
      encryption-key:
        type: string
        description: "A Godot script encryption key to embed within the export template."
        required: false

      # MacOS-specific inputs.
      codesign-certificate-file:
        type: string
        description: "The codesigning certificate file (only used on MacOS)."
        required: false
      codesign-certificate-password:
        type: string
        description: "The codesigning certificate password (only used on MacOS)."
        required: false
      codesign-provisioning-profile:
        type: string
        description: "The codesigning provisioning profile (only used on MacOS)."
        required: false
      notarization-api-uuid:
        type: string
        description: "The notarization API UUID (only used on MacOS)."
        required: false
      notarization-api-key:
        type: string
        description: "The notarization API key (only used on MacOS)."
        required: false
      notarization-api-key-id:
        type: string
        description: "The notarization API key ID (only used on MacOS)."
        required: false
      notarization-apple-id-name:
        type: string
        description: "The notarization Apple ID name (only used on MacOS)."
        required: false
      notarization-apple-id-password:
        type: string
        description: "The notarization Apple ID name (only used on MacOS)."
        required: false

      # Windows-specific inputs.
      codesign-identity-type:
        type: string
        description: "The codesigning identity type (only used on Windows)."
        required: false
      codesign-identity:
        type: string
        description: "The codesigning identity (only used on Windows)."
        required: false
      codesign-password:
        type: string
        description: "The codesigning password for the identity (only used on Windows)."
        required: false

      timeout:
        type: number
        description: "The workflow's maximum allowed run duration (in minutes)."
        required: false
        default: 60

    outputs:
      path:
        description: "The name of the Godot project export preset artifact."
        value: ${{ jobs.export.outputs.name }}

defaults:
  run:
    shell: bash

jobs:
  export:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(inputs.timeout) }}

    outputs:
      name: TODO

    steps:
      - uses: actions/checkout@v4

      # ------------------------- Set up the project ------------------------- #

      - uses: ./.github/actions/setup-godot
        with:
          version: ${{ inputs.godot-editor-version }}
          install-dir: ${{ github.workspace }}

      # ---------------------- Export the project preset --------------------- #

      - name: Export the project preset
        id: export-preset
        uses: ./export-godot-project-preset
        with:
          encryption-key: ${{ inputs.encryption-key }}
          export-template-artifact-name: ${{ inputs.export-template-artifact-name }}
          godot-editor-path: ${{ github.workspace }}/bin/godot
          pck-only: ${{ inputs.pck-only }}
          preset-name: ${{ inputs.preset-name }}
          preset-output-name: ${{ inputs.preset-output-name }}
          profile: ${{ inputs.profile }}
          project-path: ${{ inputs.project-path }}

          # MacOS-specific inputs.
          codesign-certificate-file: ${{ inputs.codesign-certificate-file }}
          codesign-certificate-password: ${{ inputs.codesign-certificate-password }}
          codesign-provisioning-profile: ${{ inputs.codesign-provisioning-profile }}
          notarization-api-uuid: ${{ inputs.notarization-api-uuid }}
          notarization-api-key: ${{ inputs.notarization-api-key }}
          notarization-api-key-id: ${{ inputs.notarization-api-key-id }}
          notarization-apple-id-name: ${{ inputs.notarization-apple-id-name }}
          notarization-apple-id-password: ${{ inputs.notarization-apple-id-password }}

          # Windows-specific inputs.
          codesign-identity-type: ${{ inputs.codesign-identity-type }}
          codesign-identity: ${{ inputs.codesign-identity }}
          codesign-password: ${{ inputs.codesign-password }}

      # ----------------- Package the exported project preset ---------------- #

      # Publish the artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.preset-output-name }}
          path: ${{ steps.export-preset.outputs.path }}
          if-no-files-found: error
