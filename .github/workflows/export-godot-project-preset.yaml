name: "ðŸ¤– Export: Godot project preset"

on:
  workflow_call:
    inputs:
      project-path:
        type: string
        description: "The path to the Godot project."
        required: true

      preset-name:
        type: string
        description: "The name of the Godot project export preset."
        required: true
      preset-output-name:
        type: string
        description: "The output filename of the exported Godot project preset."
        required: true
      pck-only:
        type: boolean
        description: "Whether to export a PCK file instead of an executable."
        required: false
        default: false

      godot-editor-version:
        type: string
        description: "The full semantic version of the Godot editor."
        required: true
      export-template-artifact-name:
        type: string
        description: "The name of the Godot export template artifact to download."
        required: true

      profile:
        type: string
        description: "The optimization profile of the compiled export template."
        required: false
        default: release
      encryption-key:
        type: string
        description: "A Godot script encryption key to embed within the export template."
        required: false

      # MacOS-specific inputs.
      codesign-certificate-file:
        type: string
        description: "The codesigning certificate file (only used on MacOS)."
        required: false
      codesign-certificate-password:
        type: string
        description: "The codesigning certificate password (only used on MacOS)."
        required: false
      codesign-provisioning-profile:
        type: string
        description: "The codesigning provisioning profile (only used on MacOS)."
        required: false
      notarization-api-uuid:
        type: string
        description: "The notarization API UUID (only used on MacOS)."
        required: false
      notarization-api-key:
        type: string
        description: "The notarization API key (only used on MacOS)."
        required: false
      notarization-api-key-id:
        type: string
        description: "The notarization API key ID (only used on MacOS)."
        required: false
      notarization-apple-id-name:
        type: string
        description: "The notarization Apple ID name (only used on MacOS)."
        required: false
      notarization-apple-id-password:
        type: string
        description: "The notarization Apple ID name (only used on MacOS)."
        required: false

      # Windows-specific inputs.
      codesign-identity-type:
        type: string
        description: "The codesigning identity type (only used on Windows)."
        required: false
      codesign-identity:
        type: string
        description: "The codesigning identity (only used on Windows)."
        required: false
      codesign-password:
        type: string
        description: "The codesigning password for the identity (only used on Windows)."
        required: false

      timeout:
        type: number
        description: "The workflow's maximum allowed run duration (in minutes)."
        required: false
        default: 60

    outputs:
      name:
        description: "The artifact name for the exported project preset."
        value: ${{ jobs.export.outputs.name }}

defaults:
  run:
    shell: bash

jobs:
  export:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(inputs.timeout) }}

    outputs:
      name: ${{ inputs.preset-output-name }}

    steps:
      - uses: actions/checkout@v4

      # ------------------------- Set up the project ------------------------- #

      - uses: coffeebeats/godot-infra/.github/actions/setup-godot@v0
        with:
          version: ${{ inputs.godot-editor-version }}
          install-dir: ${{ github.workspace }}/.godot

      # ---------------------- Export the project preset --------------------- #

      - name: Export the project preset
        id: export-preset
        uses: coffeebeats/godot-infra/export-godot-project-preset@v0
        with:
          preset-name: ${{ inputs.preset-name }}
          preset-output-name: ${{ inputs.preset-output-name }}

          project-path: ${{ inputs.project-path }}
          godot-editor-path: ${{ github.workspace }}/.godot/bin/godot
          export-template-artifact-name: ${{ inputs.export-template-artifact-name }}

          encryption-key: ${{ inputs.encryption-key }}
          pck-only: ${{ inputs.pck-only }}
          profile: ${{ inputs.profile }}

          # MacOS-specific inputs.
          codesign-certificate-file: ${{ inputs.codesign-certificate-file }}
          codesign-certificate-password: ${{ inputs.codesign-certificate-password }}
          codesign-provisioning-profile: ${{ inputs.codesign-provisioning-profile }}
          notarization-api-uuid: ${{ inputs.notarization-api-uuid }}
          notarization-api-key: ${{ inputs.notarization-api-key }}
          notarization-api-key-id: ${{ inputs.notarization-api-key-id }}
          notarization-apple-id-name: ${{ inputs.notarization-apple-id-name }}
          notarization-apple-id-password: ${{ inputs.notarization-apple-id-password }}

          # Windows-specific inputs.
          codesign-identity-type: ${{ inputs.codesign-identity-type }}
          codesign-identity: ${{ inputs.codesign-identity }}
          codesign-password: ${{ inputs.codesign-password }}

      # --------------------- Publish generated artifacts -------------------- #

      # NOTE: Runnable MacOS exports are directories, which don't get uploaded
      # correctly when the export path is used directly. To handle this case,
      # create a wrapper directory and upload that instead.
      - name: Normalize artifact path
        id: artifact
        run: |
          ARTIFACT_PATH="${{ steps.export-preset.outputs.path }}"

          if [[ -d "$ARTIFACT_PATH" ]]; then
            WRAPPER_DIR="${{ runner.temp }}/dist"

            mkdir "$WRAPPER_DIR"
            sudo mv "$ARTIFACT_PATH" "$WRAPPER_DIR"

            ARTIFACT_PATH="$WRAPPER_DIR"
          fi

          echo "path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT

      # Exported project preset
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.preset-output-name }}
          path: ${{ steps.artifact.outputs.path }}
          if-no-files-found: error
