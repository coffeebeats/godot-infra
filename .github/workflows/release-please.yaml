name: "ðŸš€ Release: 'godot-infra'"

on:
  push:
    branches:
      - godot-v*

env:
  # This is required to use the 'gh' CLI in actions.
  GH_TOKEN: ${{ github.token }}

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    timeout-minutes: 4

    outputs:
      release-created: ${{ steps.release.outputs.releases_created }}
      release-tag: ${{ steps.release.outputs.tag_name }}

    steps:
      - uses: google-github-actions/release-please-action@v4
        id: release
        with:
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

          # NOTE: To handle releases on specific branches (e.g. a '1.X' release branch),
          # simply change the "branches" filter in the workflow's on-"push" trigger.
          target-branch: ${{ github.ref_name }}

  publish-images:
    needs: ["release-please"]
    if: needs.release-please.outputs.release-created == 'true'

    strategy:
      fail-fast: true
      max-parallel: 2

      matrix:
        included:
          - image: compile-godot-export-template
            context: macos
            timeout: 60
          - image: compile-godot-export-template
            platform: windows
            timeout: 30

          - image: export-godot-project-preset
            platform: macos
            timeout: 10
          - image: export-godot-project-preset
            platform: windows
            timeout: 10

    uses: "./.github/workflows/publish-image-${{ matrix.image }}-${{ matrix.platform }}.yaml"
    with:
      timeout: ${{ matrix.timeout }}
